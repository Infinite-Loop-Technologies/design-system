package loop:fx@0.1.0;

use loop:core@0.1.0/{cancel-token};

world fx {
  type node-id = u64
  type component-id = string

  type prop = record { key: string, value: string }
  type props = list<prop>

  type node-spec = record {
    component: component-id,
    key: option<string>,
    props: props,
  }

  type render-result = record {
    id: node-id,
    reused: bool,
  }

  export graph: interface {
    /// Mount or reuse the root node; returns a stable node id and whether it was reused.
    mount-root: func(spec: node-spec) -> render-result

    /// Render a child at a positional index. Hosts can reuse existing nodes when keys match.
    render-child: func(parent: node-id, spec: node-spec, position: u32) -> render-result

    /// Signal that children for a parent are finalized for this tick.
    seal: func(parent: node-id, child-count: u32)

    /// Dispose a node (and its subtree) explicitly.
    dispose: func(node: node-id)
  }

  export hooks: interface {
    /// Persistent state slot. Returns the current value (string-serde decided by the component runtime).
    use-state: func(node: node-id, slot: u32, initial: option<string>) -> string

    /// Enqueue a state change; host schedules a re-render for the node.
    set-state: func(node: node-id, slot: u32, value: string)

    /// Track a resource keyed by an id/token (e.g., subscriptions, async tasks).
    use-resource: func(node: node-id, slot: u32, key: option<string>, token: option<string>) -> option<string>

    /// Mark the node dirty without changing state (useful for external signals).
    mark-dirty: func(node: node-id)
  }

  export scheduler: interface {
    /// Request that the host schedules another render tick.
    request-tick: func()

    /// Advance the scheduler; returns true if more work remains.
    tick: func() -> bool

    /// Sleep with cancellation support (paired with loop:core cancel tokens).
    sleep: func(token: cancel-token, ms: u64) -> bool
  }

  export yields: interface {
    /// Yield a value up the tree (e.g., layout metrics or command payloads).
    yield-value: func(node: node-id, value: option<string>)

    /// Bubble an error to the host/runtime for logging or restart.
    bubble-error: func(node: node-id, message: string)
  }
}
